<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Maker with Feedback and Question Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .hidden {
            display: none;
        }
        #feedback-form, #question-generation, #version-history, #version-details {
            margin-top: 20px;
        }
        button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .version-list-item {
            cursor: pointer;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .version-list-item:hover {
            background-color: #f0f0f0;
        }
        #generated-questions {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="test-maker">
        <h1>Test Maker</h1>
        <form id="test-form">
            <div>
                <label for="test-title">Test Title:</label>
                <input type="text" id="test-title" required>
            </div>
            <div>
                <label for="test-description">Description:</label>
                <textarea id="test-description" rows="4" required></textarea>
            </div>
            <div>
                <button type="button" onclick="saveTest()">Save Test</button>
                <button type="button" onclick="showVersionHistory()">View Version History</button>
            </div>
        </form>
    </div>

    <div id="feedback-form" class="hidden">
        <h2>Provide Feedback</h2>
        <form>
            <div>
                <label for="feedback-test-id">Test ID:</label>
                <input type="text" id="feedback-test-id" required>
            </div>
            <div>
                <label for="feedback-question-id">Question ID:</label>
                <input type="text" id="feedback-question-id" required>
            </div>
            <div>
                <label for="feedback-comments">Comments:</label>
                <textarea id="feedback-comments" rows="4" required></textarea>
            </div>
            <button type="button" onclick="submitFeedback()">Submit Feedback</button>
        </form>
    </div>

    <div id="question-generation">
        <h2>Generate Questions</h2>
        <form>
            <div>
                <label for="topic">Topic:</label>
                <input type="text" id="topic" required>
            </div>
            <div>
                <button type="button" onclick="generateQuestions()">Generate Questions</button>
            </div>
        </form>
        <div id="generated-questions"></div>
    </div>

    <div id="version-history" class="hidden">
        <h2>Version History</h2>
        <ul id="version-list"></ul>
        <button onclick="hideVersionHistory()">Close</button>
    </div>

    <div id="version-details" class="hidden">
        <h2>Version Details</h2>
        <div id="version-content"></div>
        <button onclick="restoreVersion()">Restore Version</button>
        <button onclick="hideVersionDetails()">Close</button>
    </div>

    <script>
        const testId = 'example-test-id'; 

        async function saveTest() {
            const title = document.getElementById('test-title').value;
            const description = document.getElementById('test-description').value;
            const content = JSON.stringify({ title, description });

            try {
                const response = await fetch('/api/save-version', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, content })
                });

                if (response.ok) {
                    alert('Test version saved successfully.');
                } else {
                    alert('Failed to save test version.');
                }
            } catch {
                alert('Error saving test version.');
            }
        }

        async function showVersionHistory() {
            try {
                const response = await fetch(`/api/version-history/${testId}`);
                const versions = await response.json();

                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';

                versions.forEach(version => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Version ${version.version_number} - ${new Date(version.created_at).toLocaleString()}`;
                    listItem.className = 'version-list-item';
                    listItem.onclick = () => showVersionDetails(version.version_id);
                    versionList.appendChild(listItem);
                });

                document.getElementById('version-history').classList.remove('hidden');
            } catch {
                alert('Error fetching version history.');
            }
        }

        async function showVersionDetails(versionId) {
            try {
                const response = await fetch(`/api/version/${versionId}`);
                const version = await response.json();

                document.getElementById('version-content').textContent = version.content;
                document.getElementById('version-details').dataset.versionId = versionId;
                document.getElementById('version-details').classList.remove('hidden');
            } catch {
                alert('Error fetching version details.');
            }
        }

        async function restoreVersion() {
            const versionId = document.getElementById('version-details').dataset.versionId;

            try {
                const response = await fetch('/api/restore-version', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, versionId })
                });

                if (response.ok) {
                    alert('Test restored to the selected version.');
                } else {
                    alert('Failed to restore version.');
                }
            } catch {
                alert('Error restoring version.');
            }
        }

        function hideVersionHistory() {
            document.getElementById('version-history').classList.add('hidden');
        }

        function hideVersionDetails() {
            document.getElementById('version-details').classList.add('hidden');
        }

        async function submitFeedback() {
            const testId = document.getElementById('feedback-test-id').value;
            const questionId = document.getElementById('feedback-question-id').value;
            const comments = document.getElementById('feedback-comments').value;

            try {
                const response = await fetch('/api/submit-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, questionId, comments })
                });

                if (response.ok) {
                    alert('Feedback submitted successfully.');
                } else {
                    alert('Failed to submit feedback.');
                }
            } catch {
                alert('Error submitting feedback.');
            }
        }

        async function generateQuestions() {
            const topic = document.getElementById('topic').value;

            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const questions = await response.json();

                const generatedQuestionsDiv = document.getElementById('generated-questions');
                generatedQuestionsDiv.innerHTML = '<h3>Generated Questions:</h3>';

                questions.forEach(question => {
                    const p = document.createElement('p');
                    p.textContent = question.text;
                    generatedQuestionsDiv.appendChild(p);
                });
            } catch {
                alert('Error generating questions.');
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Maker with Collaboration and Analytics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
            background-color: #f9f9f9;
        }
        .hidden {
            display: none;
        }
        #test-maker, #feedback-form, #question-generation, #adaptive-testing, #collaboration, #analytics-reporting, #version-history, #version-details {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:focus {
            outline: 2px solid #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .version-list-item {
            cursor: pointer;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .version-list-item:hover {
            background-color: #f0f0f0;
        }
        @media (max-width: 600px) {
            button {
                width: 100%;
            }
            input, textarea {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="test-maker" role="region" aria-labelledby="test-maker-heading">
        <h1 id="test-maker-heading">Test Maker</h1>
        <form id="test-form" aria-labelledby="test-maker-heading">
            <div>
                <label for="test-title">Test Title:</label>
                <input type="text" id="test-title" aria-required="true" required>
            </div>
            <div>
                <label for="test-description">Description:</label>
                <textarea id="test-description" rows="4" aria-required="true" required></textarea>
            </div>
            <div>
                <button type="button" onclick="saveTest()">Save Test</button>
                <button type="button" onclick="showVersionHistory()">View Version History</button>
            </div>
        </form>
    </div>

    <div id="feedback-form" class="hidden" role="region" aria-labelledby="feedback-form-heading">
        <h2 id="feedback-form-heading">Provide Feedback</h2>
        <form>
            <div>
                <label for="feedback-test-id">Test ID:</label>
                <input type="text" id="feedback-test-id" aria-required="true" required>
            </div>
            <div>
                <label for="feedback-question-id">Question ID:</label>
                <input type="text" id="feedback-question-id" aria-required="true" required>
            </div>
            <div>
                <label for="feedback-comments">Comments:</label>
                <textarea id="feedback-comments" rows="4" aria-required="true" required></textarea>
            </div>
            <button type="button" onclick="submitFeedback()">Submit Feedback</button>
        </form>
    </div>

    <div id="question-generation" role="region" aria-labelledby="question-generation-heading">
        <h2 id="question-generation-heading">Generate Questions</h2>
        <form>
            <div>
                <label for="topic">Topic:</label>
                <input type="text" id="topic" aria-required="true" required>
            </div>
            <div>
                <button type="button" onclick="generateQuestions()">Generate Questions</button>
            </div>
        </form>
        <div id="generated-questions"></div>
    </div>

    <div id="adaptive-testing" class="hidden" role="region" aria-labelledby="adaptive-testing-heading">
        <h2 id="adaptive-testing-heading">Adaptive Testing</h2>
        <button type="button" onclick="startAdaptiveTest()">Start Test</button>
        <div id="question-section" class="hidden" role="region" aria-labelledby="question-section-heading">
            <div id="question-text" aria-live="polite"></div>
            <input type="text" id="answer-input" placeholder="Your answer" aria-required="true">
            <button type="button" onclick="submitAnswer()">Submit Answer</button>
        </div>
        <div id="test-results" class="hidden" role="region" aria-labelledby="test-results-heading">
            <h3 id="test-results-heading">Test Results</h3>
            <div id="score"></div>
            <div id="achievements"></div>
        </div>
    </div>

    <div id="collaboration" role="region" aria-labelledby="collaboration-heading">
        <h2 id="collaboration-heading">Real-Time Collaboration</h2>
        <form>
            <div>
                <label for="collaborator-email">Collaborator Email:</label>
                <input type="email" id="collaborator-email" aria-required="true" required>
            </div>
            <div>
                <button type="button" onclick="addCollaborator()">Add Collaborator</button>
            </div>
        </form>
        <div id="collaborators-list" role="region" aria-labelledby="collaborators-list-heading">
            <h3 id="collaborators-list-heading">Current Collaborators:</h3>
        </div>
    </div>

    <div id="analytics-reporting" role="region" aria-labelledby="analytics-reporting-heading">
        <h2 id="analytics-reporting-heading">Advanced Analytics and Reporting</h2>
        <button type="button" onclick="viewAnalytics()">View Analytics</button>
        <div id="analytics-details" class="hidden" role="region" aria-labelledby="analytics-details-heading">
            <h3 id="analytics-details-heading">Test Analytics</h3>
            <div id="analytics-content"></div>
            <button type="button" onclick="hideAnalytics()">Close</button>
        </div>
    </div>

    <div id="version-history" class="hidden" role="region" aria-labelledby="version-history-heading">
        <h2 id="version-history-heading">Version History</h2>
        <ul id="version-list"></ul>
        <button type="button" onclick="hideVersionHistory()">Close</button>
    </div>

    <div id="version-details" class="hidden" role="region" aria-labelledby="version-details-heading">
        <h2 id="version-details-heading">Version Details</h2>
        <div id="version-content"></div>
        <button type="button" onclick="restoreVersion()">Restore Version</button>
        <button type="button" onclick="hideVersionDetails()">Close</button>
    </div>

    <script>
        const testId = 'example-test-id';

        async function saveTest() {
            const title = document.getElementById('test-title').value;
            const description = document.getElementById('test-description').value;
            const content = JSON.stringify({ title, description });

            try {
                const response = await fetch('/api/save-version', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, content })
                });

                if (response.ok) {
                    alert('Test version saved successfully.');
                } else {
                    alert('Failed to save test version.');
                }
            } catch {
                alert('Error saving test version.');
            }
        }

        async function showVersionHistory() {
            try {
                const response = await fetch(`/api/version-history/${testId}`);
                const versions = await response.json();

                const versionList = document.getElementById('version-list');
                versionList.innerHTML = '';

                versions.forEach(version => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Version ${version.version_number} - ${new Date(version.created_at).toLocaleString()}`;
                    listItem.className = 'version-list-item';
                    listItem.onclick = () => showVersionDetails(version.version_id);
                    versionList.appendChild(listItem);
                });

                document.getElementById('version-history').classList.remove('hidden');
            } catch {
                alert('Error fetching version history.');
            }
        }

        async function showVersionDetails(versionId) {
            try {
                const response = await fetch(`/api/version/${versionId}`);
                const version = await response.json();

                document.getElementById('version-content').textContent = version.content;
                document.getElementById('version-details').dataset.versionId = versionId;
                document.getElementById('version-details').classList.remove('hidden');
            } catch {
                alert('Error fetching version details.');
            }
        }

        async function restoreVersion() {
            const versionId = document.getElementById('version-details').dataset.versionId;

            try {
                const response = await fetch('/api/restore-version', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, versionId })
                });

                if (response.ok) {
                    alert('Test restored to the selected version.');
                } else {
                    alert('Failed to restore version.');
                }
            } catch {
                alert('Error restoring version.');
            }
        }

        function hideVersionHistory() {
            document.getElementById('version-history').classList.add('hidden');
        }

        function hideVersionDetails() {
            document.getElementById('version-details').classList.add('hidden');
        }

        async function submitFeedback() {
            const testId = document.getElementById('feedback-test-id').value;
            const questionId = document.getElementById('feedback-question-id').value;
            const comments = document.getElementById('feedback-comments').value;

            try {
                const response = await fetch('/api/submit-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, questionId, comments })
                });

                if (response.ok) {
                    alert('Feedback submitted successfully.');
                } else {
                    alert('Failed to submit feedback.');
                }
            } catch {
                alert('Error submitting feedback.');
            }
        }

        async function generateQuestions() {
            const topic = document.getElementById('topic').value;

            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const questions = await response.json();

                const generatedQuestionsDiv = document.getElementById('generated-questions');
                generatedQuestionsDiv.innerHTML = '<h3>Generated Questions:</h3>';

                questions.forEach(question => {
                    const p = document.createElement('p');
                    p.textContent = question.text;
                    generatedQuestionsDiv.appendChild(p);
                });
            } catch {
                alert('Error generating questions.');
            }
        }

        async function startAdaptiveTest() {
            document.getElementById('adaptive-testing').classList.remove('hidden');
            document.getElementById('question-section').classList.remove('hidden');

            try {
                const response = await fetch('/api/start-adaptive-test');
                const question = await response.json();

                document.getElementById('question-text').textContent = question.text;
            } catch {
                alert('Error starting adaptive test.');
            }
        }

        async function submitAnswer() {
            const answer = document.getElementById('answer-input').value;

            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer })
                });
                const result = await response.json();

                document.getElementById('question-text').textContent = result.nextQuestion.text;
                document.getElementById('score').textContent = `Score: ${result.score}`;
                document.getElementById('achievements').textContent = `Achievements: ${result.achievements.join(', ')}`;
            } catch {
                alert('Error submitting answer.');
            }
        }

        async function addCollaborator() {
            const email = document.getElementById('collaborator-email').value;

            try {
                const response = await fetch('/api/add-collaborator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testId, email })
                });

                if (response.ok) {
                    alert('Collaborator added successfully.');
                    loadCollaborators();
                } else {
                    alert('Failed to add collaborator.');
                }
            } catch {
                alert('Error adding collaborator.');
            }
        }

        async function loadCollaborators() {
            try {
                const response = await fetch(`/api/collaborators/${testId}`);
                const collaborators = await response.json();

                const collaboratorsList = document.getElementById('collaborators-list');
                collaboratorsList.innerHTML = '<h3>Current Collaborators:</h3>';

                collaborators.forEach(collaborator => {
                    const p = document.createElement('p');
                    p.textContent = collaborator.email;
                    collaboratorsList.appendChild(p);
                });
            } catch {
                alert('Error loading collaborators.');
            }
        }

        async function viewAnalytics() {
            try {
                const response = await fetch(`/api/analytics/${testId}`);
                const analytics = await response.json();

                const analyticsContent = document.getElementById('analytics-content');
                analyticsContent.innerHTML = `<p><strong>Total Tests Taken:</strong> ${analytics.totalTests}</p>
                                              <p><strong>Average Score:</strong> ${analytics.averageScore}</p>
                                              <p><strong>Top Performer:</strong> ${analytics.topPerformer.email} (${analytics.topPerformer.score})</p>`;

                document.getElementById('analytics-details').classList.remove('hidden');
            } catch {
                alert('Error fetching analytics.');
            }
        }

        function hideAnalytics() {
            document.getElementById('analytics-details').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCollaborators();
        });
    </script>
</body>
</html>
